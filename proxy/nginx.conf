    load_module modules/ngx_http_modsecurity_module.so;
    user  nginx;
    worker_processes 4;

    events { 
        worker_connections 1024; 
    }

    http {
        include /etc/nginx/conf.d/*.conf;
        
        log_format custom '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            '"$http_referer" "$http_user_agent" "$http_x_forwarded_for" "$gzip_ratio"';
                 
        access_log /var/log/nginx/access.log;
        error_log  /var/log/nginx/error.log;

        limit_req_zone $binary_remote_addr zone=one:10m rate=30r/s;
        limit_conn_zone $binary_remote_addr zone=two:10m;

        # load balancing
        upstream user {
            least_conn;
            # zone user 32k;
            server filmbackendmysql-user-3:5000 max_conns=30;
            server filmbackendmysql-user-2:5000 max_conns=30;
            server filmbackendmysql-user-1:5000 max_conns=30;
        }
        upstream admin {
            least_conn;
            # zone admin 32k;
            server filmbackendmysql-admin-3:5002 max_conns=30;
            server filmbackendmysql-admin-2:5002 max_conns=30;
            server filmbackendmysql-admin-1:5002 max_conns=30;
        }
        upstream film {
            least_conn;
            zone film 32k;
            server filmbackendmysql-film-1:5003 max_conns=30;
            server filmbackendmysql-film-2:5003 max_conns=30;
            server filmbackendmysql-film-3:5003 max_conns=30;

        }

        upstream rbac {
            least_conn; #gui request den may chu co so luong xu ly it nhat
            # zone backend 32k;
            server filmbackendmysql-rbac-1:5004 max_conns=30;
            server filmbackendmysql-rbac-2:5004 max_conns=30;
            server filmbackendmysql-rbac-3:5004 max_conns=30;
        }

        upstream nextjs {
            least_conn;
            # zone backend 32k;
            server filmbackendmysql-nextjs-1:3000 max_conns=30;
            server filmbackendmysql-nextjs-2:3000 max_conns=30;
            server filmbackendmysql-nextjs-3:3000 max_conns=30;
        }
        upstream nextjs-admin {
            least_conn;
            # zone backend 32k;
            server filmbackendmysql-nextjs-admin-1:3001 max_conns=30;
            server filmbackendmysql-nextjs-admin-2:3001 max_conns=30;
            server filmbackendmysql-nextjs-admin-3:3001 max_conns=30;
        }

      

        # server {
        #     listen 80;
        #     server_name localhost; 
        #     # Chuyển hướng tất cả HTTP yêu cầu sang HTTPS
        #     return 301 https://$host$request_uri;
        # }

        server {
            # tls certification
            listen 443 ssl;
            server_name localhost;

            ssl_certificate /etc/ssl/certs/selfsigned.crt;
            ssl_certificate_key /etc/ssl/certs/selfsigned.key;
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_prefer_server_ciphers on;
            ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384";

            access_log  /var/log/nginx/access.log custom;
            error_log  /var/log/nginx/error.log warn;
            charset utf-8;

            # for frontend can connect to backend through https
            # location / {
            #     add_header 'Access-Control-Allow-Origin' '*';
            #     add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PATCH';
            #     add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, x-client-id';
            # }
            modsecurity on;
            modsecurity_rules_file /etc/nginx/modsec/main.conf;

            if ($http_host ~* "169\.254\.169\.254") {
                return 403;
            }
            if ($remote_addr = "169.254.169.254") {
                return 403;
            }
            if ($http_host ~* "aws.zaproxy.org") {
                return 403;
            }
              if ($http_host ~* "alibaba.zaproxy.org") {
                return 403;
            }
            if ($http_host ~* "100\.100\.100\.200") {
                return 403;
            }

            server_tokens off;
            location / {
                # auth_basic "Restricted Content";
                # auth_basic_user_file /etc/nginx/.htpasswd; 
                limit_conn two 60;
                proxy_pass http://nextjs;
                proxy_http_version 1.1;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_cache_bypass $http_upgrade;
                add_header X-Content-Type-Options nosniff always;
                add_header X-Frame-Options "SAMEORIGIN";
                proxy_hide_header X-Powered-By;
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
                add_header Content-Security-Policy "connect-src 'self' https://cdn.plyr.io https://s2.phim1280.tv;media-src 'self' blob:;object-src 'none'; img-src 'self' https://cdn.plyr.io https://localhost https://res.cloudinary.com http://res.cloudinary.com data:;frame-ancestors 'none';form-action 'self'; manifest-src 'self' https://localhost/sitemap.xml https://localhost/logo-film.png&w=96&q=75 https://localhost/robots.txt;" always;
                add_header Cache-Control "no-store, no-cache, must-revalidate, private";
            }
             location /adminpage {
                auth_basic "Restricted Content";
                auth_basic_user_file /etc/nginx/.htpasswd; 
                limit_conn two 60;
                proxy_pass http://nextjs-admin;
                proxy_http_version 1.1;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_cache_bypass $http_upgrade;
                add_header X-Content-Type-Options nosniff always;
                add_header X-Frame-Options "SAMEORIGIN";
                proxy_hide_header X-Powered-By;
               # Đảm bảo CSP được áp dụng cho trang sitemap
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
                add_header Content-Security-Policy "connect-src 'self' https://cdn.plyr.io https://s2.phim1280.tv;media-src 'self' blob:;object-src 'none';" always;
                add_header Cache-Control "no-store, no-cache, must-revalidate, private";
            }
           
            location /rbac {
                limit_req zone=one burst=10 nodelay;
                limit_conn two 60;
                proxy_pass http://rbac;
                proxy_http_version 1.1;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_cache_bypass $http_upgrade;
                proxy_connect_timeout 1s;  # Thời gian chờ kết nối
                proxy_send_timeout 10s;
                proxy_read_timeout 10s;
                add_header X-Content-Type-Options nosniff always;
                add_header X-Frame-Options "SAMEORIGIN";
                add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; connect-src 'self'; frame-ancestors 'self';";
               
            }
            location /user {  
                limit_req zone=one burst=10 nodelay;
                limit_conn two 60;
                proxy_pass http://user;
                proxy_http_version 1.1;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_cache_bypass $http_upgrade;
                proxy_connect_timeout 1s;  # Thời gian chờ kết nối
                proxy_send_timeout 10s;
                proxy_read_timeout 10s;
                add_header X-Content-Type-Options nosniff always;
                add_header X-Frame-Options "SAMEORIGIN";
                add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; connect-src 'self'; frame-ancestors 'self';";
         
            }

            location /admin {
                limit_req zone=one burst=10 nodelay;
                limit_conn two 60;
                proxy_pass http://admin;
                proxy_http_version 1.1;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_cache_bypass $http_upgrade;
                proxy_connect_timeout 1s;  # Thời gian chờ kết nối
                proxy_send_timeout 10s;
                proxy_read_timeout 10s;
                add_header X-Content-Type-Options nosniff always;
                add_header X-Frame-Options "SAMEORIGIN";
                add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; connect-src 'self'; frame-ancestors 'self';";
            }

            location /film {     
                limit_req zone=one burst=10 nodelay;
                limit_conn two 90;
                proxy_pass http://film;
                proxy_http_version 1.1;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_cache_bypass $http_upgrade;
                proxy_connect_timeout 1s;  # Thời gian chờ kết nối
                proxy_send_timeout 10s;
                proxy_read_timeout 10s;
                add_header X-Content-Type-Options nosniff always;
                add_header X-Frame-Options "SAMEORIGIN";
                add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; connect-src 'self'; frame-ancestors 'self';";
            }
           
        }
    }